#REQUIRED: Modbus transaction function code (see www.modbus.org specifications).
#    fnct_01_read_coils               (01 = 0x01) (new in 1.1)
#    fnct_02_read_discrete_inputs     (02 = 0x02)
#    fnct_03_read_holding_registers   (03 = 0x03)
#    fnct_04_read_input_registers     (04 = 0x04)
#    fnct_05_write_single_coil        (05 = 0x05) (new in 1.1)
#    fnct_06_write_single_register    (06 = 0x06)
#    fnct_15_write_multiple_coils     (15 = 0x0F)
#    fnct_16_write_multiple_registers (16 = 0x10)
#
# Created pins:
# fnct_01_read_coils:
# fnct_02_read_discrete_inputs:
#     mb2hal.m.n.bit     (output)
#     mb2hal.m.n.bit-inv (output)
# fnct_03_read_holding_registers:
# fnct_04_read_input_registers:
#     mb2hal.m.n.float   (output)
#     mb2hal.m.n.int     (output)
# fnct_05_write_single_coil:
#     mb2hal.m.n.bit     (input)
#         NELEMENTS needs to be 1 or PIN_NAMES must contain just one name.
# fnct_06_write_single_register:
#     mb2hal.m.n.float   (input)
#     mb2hal.m.n.int     (input)
#     NELEMENTS needs to be 1 or PIN_NAMES must contain just one name.
#     Both pin values are added and limited to 65535 (UINT16_MAX). Normally use one and let the other open (read as 0).
# fnct_15_write_multiple_coils:
#     mb2hal.m.n.bit     (input)
# fnct_16_write_multiple_registers:
#     mb2hal.m.n.float   (input)
#     mb2hal.m.n.int     (input)
#     Both pin values are added and limited to 65535 (UINT16_MAX). Normally use one and let the other open (read as 0).

# ++++++++++++++++++++++++
# Common section
# ++++++++++++++++++++++++
[MB2HAL_INIT]

#OPTIONAL: Debug level of init and INI file parsing.
# 0 = silent.
# 1 = error messages (default).
# 2 = OK confirmation messages.
# 3 = debugging messages.
# 4 = maximum debugging messages (only in transactions).
INIT_DEBUG=1
#SLOWDOWN=3 

VERSION=1.1

#OPTIONAL: HAL module (component) name. Defaults to "mb2hal".
# mb = Modbus
HAL_MODULE_NAME=mb2hal
SLOWDOWN=0.0

#REQUIRED: The number of total Modbus transactions. There is no maximum.
TOTAL_TRANSACTIONS=8

[TRANSACTION_00]
LINK_TYPE=tcp
TCP_IP=192.168.3.2
TCP_PORT=502
MB_SLAVE_ID=1

FIRST_ELEMENT=0
MB_TX_CODE=fnct_02_read_discrete_inputs

HAL_TX_NAME=cab.in

#NELEMENTS=12
PIN_NAMES=\
VF12-SPINDLE_OK,\
ILK.2-AP190-Y_RES_OK,\
ILK.1-AP163-DC_BKRS_OK,\
ILK.3-AP195-ILK_LOOP_OK,\
AR17-TOOL_ROT_DISABLED,\
PNL.VB13-CLEAR_SW,\
AG113.AUX_CRT_ON,\
AS18.INVERTER_IDLE,\
TEMP.SB11-SLT_B_TEMP_OK,\
RESERVED1,\
PNL.AR13-KEY,\
TEMP.SA11-SLT_A_TEMP_OK


#DEBUG=2


[TRANSACTION_01]
FIRST_ELEMENT=0
MB_TX_CODE=fnct_15_write_multiple_coils

HAL_TX_NAME=cab.out

#NELEMENTS=20
PIN_NAMES=\
AG144-CA13.BORING_CONTACTOR,\
AG144-SA13.SPINDLE_CONTACTOR,\
AS16-AS15.INVERTER_EN_CMD,\
RESERVED2,\
AG113-AP12.MACHINE_POWER,\
RESERVED3

#DEBUG=2

[TRANSACTION_02]
# Operating Area PLC
LINK_TYPE=tcp
TCP_IP=192.168.3.3 
TCP_PORT=502
MB_SLAVE_ID=1

FIRST_ELEMENT=0
MB_TX_CODE=fnct_02_read_discrete_inputs

# Operating Area . Input
HAL_TX_NAME=opr.i

#NELEMENTS=16
PIN_NAMES=\
SA123-TOOL-REL-BUTTON,\
RESERVED2,\
SA111-TOOL-UNLOCKED-A,\
SA112-TOOL-LCKD-PRSNT,\
RESERVED5,\
RESERVED6,\
RESERVED7,\
RESERVED8,\
RESERVED9,\
RESERVED10,\
RESERVED11,\
RESERVED12,\
RESERVED13,\
RESERVED14,\
RESERVED15,\
RESERVED16


[TRANSACTION_03]
FIRST_ELEMENT=0
MB_TX_CODE=fnct_15_write_multiple_coils

# Operating Area . Output
HAL_TX_NAME=opr.o

#NELEMENTS=16
PIN_NAMES=\
SU11-SPINDLE-AIR-PURGE,\
SA114-SPINDLE-HOLD-TOOL,\
SA115-SPINDLE-RELEASE-TOOL,\
RESERVED4,\
VC11-OIL-LEVEL,\
VC12-LUBE-OVER,\
RESERVED7,\
RESERVED8,\
RESERVED9,\
RESERVED10,\
RESERVED11,\
RESERVED12,\
RESERVED13,\
RESERVED14,\
RESERVED15,\
RESERVED16






# mb2hal.ini for Yaskawa VS-616G5 VFD as Spindle via Modbus RTU

# This configuration assumes:
# - Serial port: /dev/ttyUSB0 (adjust as needed, e.g., /dev/ttyS0)
# - Baud rate: 9600 (default for H5-02=3)
# - 8 data bits, No parity, 1 stop bit (H5-03=0)
# - Slave ID: 1 (set H5-01=1 on VFD)
# - VFD parameters:
#   - b1-01 = 2 (frequency reference from serial comm)
#   - b1-02 = 2 (run command from serial comm)
#   - b1-14 = 0 (forward run from multi-function input, but we'll use control word bit 0)
#   - o2-09 = 1 (standard Modbus addressing: control at 001h, freq at 002h)
#   - E1-04 = max frequency in Hz (e.g., 60 for 60 Hz max; adjust scaling in HAL)
# - Control word (001h): Bit 0 = 1 for Run Forward (spindle on), Bit 1 = 0 (no reverse for spindle)
# - Frequency ref (002h): Value * 0.1 Hz (e.g., 600 = 60.0 Hz)
# - Status word (010h): Bit 0 = Running, Bit 5 = Ready
# - Output freq (021h): Value * 0.1 Hz
# - In your .hal file, connect:
#   - net spindle-on motion.spindle-on => control-word-bit-0-out  (use and2/or logic for full word if needed)
#   - For simple on/off: Use bit-out pins if splitting the word, or build the full 16-bit word in HAL.
#   - net spindle-speed-cmd-freq <= motion.spindle-speed-in * (SCALE_TO_HZ) => freq-ref.s32-out  (e.g., scale RPM to Hz, then *10 for register)
#   - net spindle-at-speed status-word-bit-4-in => motion.spindle-at-speed
#   - net spindle-revs output-freq.s32-in * 0.1 => motion.spindle-revs  (if monitoring in RPM, further scale)
# - Load in ini: loadusr -W mb2hal config=mb2hal.ini
# - Debug with INIT_DEBUG=1 or higher; monitor with halshow


# ++++++++++++++++++++++++
# Transactions
# ++++++++++++++++++++++++

# Transaction 00: Write Control Word (register 001h/1 decimal) - fnct_06 single register write
# Builds full 16-bit word in HAL (e.g., bit 0 for run fwd, bit 5 for reset)
[TRANSACTION_04]
# Decimal address for 001h
LINK_TYPE=serial
SERIAL_PORT=/dev/ttyUSB0
SERIAL_BAUD=4800
SERIAL_BITS=8
SERIAL_PARITY=even
SERIAL_STOP=1

MB_SLAVE_ID=1 
FIRST_ELEMENT=1
NELEMENTS=1
MB_TX_CODE=fnct_16_write_multiple_registers 

# Small delay for serial stability
SERIAL_DELAY_MS=100 
MB_RESPONSE_TIMEOUT_MS=200
MB_BYTE_TIMEOUT_MS=200

HAL_TX_NAME=spin.control-word

MAX_UPDATE_RATE=10.0  

#DEBUG=4


# Transaction 01: Write Frequency Reference (register 002h/2 decimal) 
# Value in 0.1 Hz units (e.g., 600 for 60.0 Hz)
[TRANSACTION_05]
# Inherits serial params from previous
FIRST_ELEMENT=2
NELEMENTS=1
MB_TX_CODE=fnct_16_write_multiple_registers 
HAL_TX_NAME=spin.freq-ref
MAX_UPDATE_RATE=10.0 
DEBUG=1

# Transaction 02: Read Status Word (register 010h/16 decimal) - fnct_03 read holding registers
# Bit 0: Run, Bit 2: Reverse (ignore for spindle), Bit 5: Ready, Bit 7: Fault
[TRANSACTION_06]
# Inherits serial params
# 0x10 = 16
FIRST_ELEMENT=16 
NELEMENTS=1
MB_TX_CODE=fnct_03_read_holding_registers
MB_RESPONSE_TIMEOUT_MS=500
MB_BYTE_TIMEOUT_MS=500
HAL_TX_NAME=spin.status-word
MAX_UPDATE_RATE=20.0  # Frequent status polling
DEBUG=1

# Transaction 03: Read Output Frequency (register 021h/33 decimal) - fnct_03 read holding registers
# Value in 0.1 Hz units
[TRANSACTION_07]
# Inherits serial params
FIRST_ELEMENT=33 
NELEMENTS=1
MB_TX_CODE=fnct_03_read_holding_registers
MB_RESPONSE_TIMEOUT_MS=500
MB_BYTE_TIMEOUT_MS=500
HAL_TX_NAME=spin.output-freq
MAX_UPDATE_RATE=10.0  # Less frequent for speed feedback
DEBUG=1
